# git-apple-llvm: mt-config

mt-config files consists of declarations of:

- `repo`, for remote repositories;
- `destination`, for declaring where to publish the generated refs;
- `declare-dir`, for declaring the full set of split directories;
- `repeat`, for repeating commits from another generated branch;
- `dir`, for declaring which remote branches to use for directory content; and
- `generate`, for declaring what to generate.

## `repo`: Declaring a repository

```
repo <name> <url>
```

where `<name>` is the local name for the remote and `<url>` is its URL.

## `destination`: Declaring a destination remote.

```
destination ( monorepo | splitref ) <repo>
```

where `<repo>` is the local name for the remote.  There are separate
declarations for generated monorepo refs (the main goal) and split repo refs
(for tracking what has been translated).  These are fetched before generating
anything (except when `--no-setup`) and pushed after (except when `--no-push`).

## `declare-dir`: Declaring a directory

```
declare-dir <name>
```

where `<name>` is the name of a directory that comes from a different split
repository and `-` declares the monorepo root.  Any directory not declared here
will be assumed to be part of the monorepo root.  All non-root directories
should be declared even if there are no downstream changes.

See also `dir`, below.

## Defining a branch

Branches are generated by interleaving commits from the associated `<dir>` and
`<repeat>` declarations.

### `repeat`: Interleaving one generated branch's commits into another

```
repeat <branch> <upstream>
repeat <branch> <upstream>{no-pass}
```

Every time there is a commit to `<upstream>`, generate a merge commit on
`<branch>` that pulls it in, excluding any changes matching `dir` directives.

This can be useful to generate consistent histories "as if" an automerger had
been pulling in all changes from an upstream branch, when in fact some
repositories had a single branch being used for two purposes.

If `{no-pass}` is added as a suffix, then repeated commits will only be added
if there's another non-repeat to process.  In other words, the generated merges
will not "pass" the commits translated by `dir` directives.

### `dir`: Generating commits from a split repo

```
dir <branch> ( <name> | '-' ) <source>
```

`dir` declares the repositories to interleave to generate `<branch>`.  The
commits are taken from `<source>`, which is expected to be a commitish (branch,
tag, commit hash, etc.) from one of the `repo` declarations, and interleaved
into `<branch>` at the directory named `<name>/`.

`<name>` must have been previously declared with `declare-dir`.

`-` can be given instead of `<name>`, which cause `<source>`'s contents to be
"dereferenced" and put at the root.  This is intended for downstream repos of
<https://git.llvm.org/git/monorepo-root.git>.  It's recommended that these
repos only have blobs; all subdirectories should be in a separate split
repository.

## `generate`: What to do, and in what order

```
generate <sort> <type> <object>
```

`generate` declares what to do, critically specifying an order of action.  The
declared actions will be completed in sorted order.  `<sort>` is designed to be
a `0`-padded number.

The currently supported values for `<type>` are:

- `mapping`: generate an svn2git mapping from all the branches in the remote
  named `<object>`.
- `branch`: generate a branch named `<object>`, using the associated
  `repeat`, and `dir` declarations.
- `splitrefs`: create splitrefs ending in `/mt-split` for the given
  pseudo-branch, updating anything that has already been mapped.
    - Like `branch`, looks for `dir` declarations.  `repeat` is not supported.
    - Only useful as a follow-up to the `mapping` command.
    - This optimization reduces work in `branch` directives by calculating and
      efficiently caching the implicitly mapped svn2git commits.
